| rex field=url "https?://(?<hostname>[^/]+)"
| eval hostname_parts = split(hostname, ".")
| mvexpand hostname_parts
| streamstats count as part_number by hostname
| eval tld_candidate = mvappend(tld_candidate, hostname_parts)
| reverse tld_candidate
| mvcombine delim="." tld_candidate
| lookup TLD.csv TLD as tld_candidate OUTPUT TLD as matched_tld
| eventstats max(matched_tld) as tld by hostname
| eval domain=if(isnotnull(tld), replace(hostname, "^(.*)\." + tld + "$", "\1"), hostname)
| table url, domain
