| rex field=url "https?://(?<hostname>[^/]+)"
| eval hostname_parts = split(hostname, ".")
| reverse hostname_parts
| eval potential_tld = hostname_parts
| mvexpand potential_tld
| streamstats current=f last(potential_tld) as prev by hostname
| eval tld_candidate = if(isnull(prev), potential_tld, potential_tld . "." . prev)
| reverse tld_candidate
| lookup TLD.csv TLD as tld_candidate OUTPUT TLD as matched_tld
| stats first(matched_tld) as tld by hostname
| eval domain=if(isnotnull(tld), replace(hostname, "^(.*)\." + tld + "$", "\1"), hostname)
| table url, domain
